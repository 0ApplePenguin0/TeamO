<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>새 보고서 작성</title>
  <!-- 폼 렌더러 관련 스타일 및 스크립트 추가 -->
  <link rel="stylesheet" href="https://formbuilder.online/assets/css/form-render.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://formbuilder.online/assets/js/form-render.min.js"></script>
</head>
<body>
<h1>새 보고서 작성</h1>
<form th:action="@{/reports/create}" th:object="${reportRequest}" method="post">
  <div>
    <label for="title">제목:</label>
    <input type="text" id="title" th:field="*{title}" required />
  </div>
  <!-- 결재 라인 선택 부분 수정 -->
  <div>
    <label for="department">부서 선택:</label>
    <select id="department" required>
      <option value="" disabled selected>부서를 선택하세요</option>
      <option th:each="dept : ${departments}" th:value="${dept.departmentId}" th:text="${dept.departmentName}"></option>
    </select>
  </div>
  <div>
    <label for="team">팀 선택:</label>
    <select id="team" required>
      <option value="" disabled selected>팀을 선택하세요</option>
    </select>
  </div>
  <!-- 결재자 선택 부분 -->
  <div>
    <label for="approver1">결재자 1:</label>
    <select id="approver1" name="approvalLineMemberIds[0]" required>
      <option value="" disabled selected>결재자 1을 선택하세요</option>
      <!-- 멤버 목록 옵션 추가 -->
    </select>
  </div>
  <div>
    <label for="approver2">결재자 2:</label>
    <select id="approver2" name="approvalLineMemberIds[1]">
      <option value="" disabled selected>결재자 2를 선택하세요</option>
      <!-- 멤버 목록 옵션 추가 -->
    </select>
  </div>
  <div>
    <label for="approver3">결재자 3:</label>
    <select id="approver3" name="approvalLineMemberIds[2]">
      <option value="" disabled selected>결재자 3을 선택하세요</option>
      <!-- 멤버 목록 옵션 추가 -->
    </select>
  </div>
  <div>
    <label for="templateId">양식 선택:</label>
    <select id="templateId" th:field="*{templateId}" required>
      <option value="" disabled selected>양식을 선택하세요</option>
      <option th:each="template : ${formTemplates}" th:value="${template.templateId}" th:text="${template.formName}"></option>
    </select>
  </div>
  <div id="form-render"></div>
  <!-- 동적 폼에서 입력된 데이터를 저장할 숨겨진 필드 -->
<!--  <input type="hidden" id="content" th:field="*{content}" name="content">-->
  <input type="hidden" id="formContent" name="formContent">
  <div>
    <button type="submit">보고서 작성</button>
  </div>
</form>
<script>
  $(document).ready(function() {
    // 양식 선택 시 해당 양식을 로드하여 폼 렌더링
    $('#templateId').change(function() {
      let templateId = $(this).val();
      if (templateId) {
        $.ajax({
          url: '/api/form-templates/' + templateId,
          method: 'GET',
          success: function(template) {
            let formRenderOptions = {
              formData: JSON.parse(template.formStructure),
              dataType: 'json'
            };
            $('#form-render').empty(); // 기존 양식 제거
            $('#form-render').formRender(formRenderOptions);
          },
          error: function() {
            alert('양식 로드에 실패했습니다.');
          }
        });
      }
    });

    // 부서 선택 시 팀 목록 로드
    $('#department').change(function() {
      let departmentId = $(this).val();
      if (departmentId) {
        $.ajax({
          url: '/api/departments/' + departmentId + '/teams',
          method: 'GET',
          success: function(teams) {
            $('#team').empty();
            $('#team').append('<option value="" disabled selected>팀을 선택하세요</option>');
            $.each(teams, function(index, team) {
              $('#team').append('<option value="' + team.teamId + '">' + team.teamName + '</option>');
            });
          },
          error: function() {
            alert('팀 목록 로드에 실패했습니다.');
          }
        });
      }
    });

    // 팀 선택 시 멤버 목록 로드
    $('#team').change(function() {
      let teamId = $(this).val();
      if (teamId) {
        $.ajax({
          url: '/api/teams/' + teamId + '/members',
          method: 'GET',
          success: function(members) {
            // 각 결재자 셀렉트 박스를 초기화하고 멤버 목록을 추가
            $('#approver1, #approver2, #approver3').each(function() {
              $(this).empty();
              $(this).append('<option value="" disabled selected>결재자를 선택하세요</option>');
              $.each(members, function(index, member) {
                $(this).append('<option value="' + member.memberId + '">' + member.memberName + '</option>');
              }.bind(this));
            });
          },
          error: function() {
            alert('멤버 목록 로드에 실패했습니다.');
          }
        });
      }
    });

    // 폼 제출 시 동적 폼의 데이터를 JSON 형태로 저장
    $('form').on('submit', function(event) {

      // 첫 번째 결재자 선택 여부 확인
      let approver1 = $('#approver1').val();
      if (!approver1) {
        alert('결재자 1을 선택해주세요.');
        event.preventDefault();
        return false;
      }

      // 중복 결재자 선택 여부 확인
      let approver2 = $('#approver2').val();
      let approver3 = $('#approver3').val();
      let approvers = [approver1, approver2, approver3].filter(Boolean);
      let uniqueApprovers = [...new Set(approvers)];

      if (approvers.length !== uniqueApprovers.length) {
        alert('동일한 결재자를 중복 선택할 수 없습니다.');
        event.preventDefault();
        return false;
      }

      // 폼 데이터를 JSON 형태로 저장
      let formData = {};
      $('#form-render').find('input, select, textarea').each(function() {
        let name = $(this).attr('name');
        let value;
        if ($(this).attr('type') === 'checkbox') {
          value = $(this).is(':checked');
        } else if ($(this).attr('type') === 'radio') {
          if ($(this).is(':checked')) {
            value = $(this).val();
          }
        } else {
          value = $(this).val();
        }

        if (name && value !== undefined && value !== '') {
          formData[name] = value;
        }
      });

      // 숨겨진 'content' 필드에 JSON 문자열로 변환한 데이터를 설정
      let contentValue = JSON.stringify(formData);
      $('#formContent').val(contentValue);
      console.log("변환한 값:", contentValue);
      console.log("hidden content value:", $('#formContent').val());


      // // 'name' 속성 제거
      //  $('#form-render').find('input, select, textarea').each(function() {
      //    $(this).removeAttr('name');
      //  });

      // 중복 제출 방지: 제출 버튼 비활성화
      $('button[type=submit]').prop('disabled', true);
    });
  });
</script>
</body>
</html>
