<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>보고서 수정</title>
  <!-- jQuery 로드 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- formRender 관련 CSS 및 JS 로드 -->
  <link rel="stylesheet" href="https://formbuilder.online/assets/css/form-render.min.css">
  <script src="https://formbuilder.online/assets/js/form-render.min.js"></script>
</head>
<body>
<h1>보고서 수정</h1>
<form th:action="@{/reports/edit/{id}(id=${reportDetail.approvalId})}" th:object="${reportDetail}" method="post">
  <div>
    <label for="title">제목:</label>
    <input type="text" id="title" th:field="*{title}" required />
  </div>
  <h2>양식 내용 수정</h2>
  <div id="form-render"></div>
  <!-- 동적 폼에서 입력된 데이터를 저장할 숨겨진 필드 -->
  <input type="hidden" th:field="*{content}" id="content">
  <div>
    <button type="submit">수정 완료</button>
  </div>
</form>
<a th:href="@{/reports/my}">내 보고서 목록으로 돌아가기</a>

<script th:inline="javascript">
  /*<![CDATA[*/
  $(document).ready(function(){
    let formStructure = /*[[${reportDetail.formStructure}]]*/ '[]';
    let formContent = /*[[${reportDetail.content}]]*/ '{}';

    // 불필요한 , 제거
 /*   if (formContent.endsWith(',')) {
      formContent = formContent.slice(0, -1);
    }
*/
    // 양식 렌더링
    try {
      $('#form-render').formRender({
        formData: JSON.parse(formStructure),
        dataType: 'json',
        readOnly: false
      });

      console.log(formContent);

      // 폼 필드에 데이터 채우기
      let contentData = JSON.parse(formContent);
      for(let key in contentData){
        if(contentData.hasOwnProperty(key)){
          let input = $('#form-render').find('[name="'+key+'"]');
          if(input.attr('type') === 'checkbox' || input.attr('type') === 'radio'){
            input.prop('checked', contentData[key] === true || contentData[key] === 'true');
          } else {
            input.val(contentData[key]);
          }
        }
      }
    } catch (e) {
      console.error("양식 렌더링 중 오류 발생:", e);
    }

    // 수정 시 양식 데이터를 숨겨진 필드에 JSON으로 저장
    $('form').submit(function(){
      let formData = {};
      $('#form-render').find('input, select, textarea').each(function(){
        let name = $(this).attr('name');
        let value;
        if($(this).attr('type') === 'checkbox'){
          value = $(this).is(':checked');
        } else if($(this).attr('type') === 'radio'){
          if($(this).is(':checked')){
            value = $(this).val();
          }
        } else {
          value = $(this).val();
        }
        if(name){
          formData[name] = value;
        }
      });
      let jsonString = JSON.stringify(formData);
      console.log("Original JSON String:", jsonString);

      // JSON 문자열의 끝에 불필요한 ,가 없는지 확인
      // jsonString = jsonString.replace(/,\s*}$/, '}');

      console.log("Final JSON String:", jsonString);
      $('#content').val(jsonString);
    });
  });
  /*]]>*/
</script>
</body>
</html>
