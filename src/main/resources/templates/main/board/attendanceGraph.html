<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>월별 출퇴근 기록</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>월별 출퇴근 기록</h1>

<button onclick="moveMonth(-1)">이전 달</button>
<button onclick="moveMonth(1)">다음 달</button>

<!-- 출퇴근 리스트 표 -->
<table border="1">
  <thead>
  <tr>
    <th>날짜</th>
    <th>출근 시간</th>
    <th>퇴근 시간</th>
    <th>근무 시간(시간)</th>
    <th>상태</th>
  </tr>
  </thead>
  <tbody>
  <tr th:each="attendance : ${monthlyAttendance}">
    <td th:text="${attendance.attendanceDate}"></td>
    <td th:text="${attendance.checkIn != null ? #temporals.format(attendance.checkIn, 'HH:mm') : '--:--'}"></td>
    <td th:text="${attendance.checkOut != null ? #temporals.format(attendance.checkOut, 'HH:mm') : '--:--'}"></td>
    <td th:text="${attendance.dailyHours != null ? T(java.lang.String).format('%.2f', attendance.dailyHours) : '--'}"></td>
    <td th:text="${attendance.status}"></td>
  </tr>
  </tbody>
</table>

<!-- 근무 시간 그래프 -->
<canvas id="attendanceChart"></canvas>

<script th:inline="javascript">
  /*<![CDATA[*/
  console.log("Script is loading");

  let currentYear = [[${year}]];
  let currentMonth = [[${month}]];

  console.log("Current Year:", currentYear);
  console.log("Current Month:", currentMonth);

  // 월 이동 함수
  function moveMonth(direction) {
    console.log("moveMonth 호출됨. direction:", direction);
    currentMonth += direction;

    if (currentMonth < 1) {
      currentMonth = 12;
      currentYear -= 1;
    } else if (currentMonth > 12) {
      currentMonth = 1;
      currentYear += 1;
    }

    console.log("Redirecting to:", `/attendance/monthly?year=${currentYear}&month=${currentMonth}`);
    window.location.href = `/attendance/monthly?year=${currentYear}&month=${currentMonth}`;
  }

  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOMContentLoaded 이벤트 발생");

    // 모델에서 전달된 출퇴근 데이터
    const attendanceData = /*[[${monthlyAttendanceJson}]]*/ '[]';

    console.log("Attendance Data:", attendanceData);

    if (attendanceData.length === 0) {
      console.error("출퇴근 데이터가 없습니다.");
      return;
    }

    // JSON 문자열을 객체로 변환
    const parsedData = JSON.parse(attendanceData);
    const labels = parsedData.map(a => a.attendanceDate);
    const dailyHours = parsedData.map(a => a.dailyHours || 0);

    const ctx = document.getElementById('attendanceChart').getContext('2d');
    const attendanceChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: '근무 시간 (시간)',
          data: dailyHours,
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderColor: 'rgb(75, 192, 192)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          x: {
            title: {
              display: true,
              text: '날짜'
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: '근무 시간 (시간)'
            }
          }
        }
      }
    });
  });
  /*]]>*/
</script>

</body>
</html>
